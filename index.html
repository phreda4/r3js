<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>r3</title>
    <link rel="stylesheet" href="https://rawgit.com/jenil/bulmaswatch/gh-pages/nuclear/bulmaswatch.min.css" />
    <script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
    <script src="./compiler.js"></script>
    <script src="./r3www.js"></script>    

<script>
function dumpmd() { var s="";
	for(var i=meminidata;i<memd;i++) {
		s=s+" "+mem.getInt8(i);
		}
	return s;
	}

function dumpmc() {	var s="";
	for(var i=0;i<memc;i++) {
//		if (i==ip) { s+=" >"; } else { s+=" "; } 
		s+=printmr3(memcode[i]);
		if (i==ip) { s+=" <--"; }
		s+="\n";
		}
	return s;
	}
function dumpdicc() { var s="";
	for (var i=0;i<dicc.length;i++) {
		s+=dicc[i]+" "+dicca[i]+" "+dicci[i]+"\n";
		}
	return s;
	}

const setDiv = (id, value) => document.getElementById(id).innerText = value;	
function dumpVM() {
	setDiv("ip", ip);
	setDiv("ds", [TOS, ...(stack.slice(2, NOS+1).reverse())].join(" "));
    setDiv("cs", stack.slice(RTOS,255).join(" "));
    setDiv("mc", dumpmc());
    setDiv("md", dumpmd());
	setDiv("dic",dumpdicc());
    }

function r3Compile() { 
	r3reset();
	if (r3token(document.getElementById("src").value)!=0) {
		}
	dumpVM(); 
	}
	
function r3Run() { 
	r3echo="";
	r3reset();
	if (r3token(document.getElementById("src").value)!=0) {
		dumpVM(); 
		return;
		}
	// error
	r3run();
	redraw();
	dumpVM(); 
	document.getElementById("r3dom").innerHTML=r3echo;
	}
	
function r3Go(a) {	
	r3echo="";
	r3Runa(a);
	document.getElementById("r3dom").innerHTML=r3echo;
	}
	
function r3Load(readFile) {
	loadFile(readFile);
	}	

function loadFile(name) {
	var d=new Date(2018,1,1,1,1,1,1);
	var file=new File(["Cargando..."],name,{type:"text/plain",lastModified:d})
	var reader = new FileReader();
	reader.onload = function(e) { 
		var contents = e.target.result;
		setDiv("ttt",contents);
		};
	reader.readAsText(file);
}
	
function loaded(evt) {
	document.getElementById('src').value=evt.target.result;
	}

</script>

  </head>

  <body>
    
  <nav class="navbar" role="navigation">
    <div class="navbar-brand">
      <h1 class="title">
        <a class="navbar-item" href="https://github.com/r3www/r3">r3)</a>
      </h1>
  
      <a role="button" class="navbar-burger burger" data-target="navbarMenu">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>
  
    <div id="navbarMenu" class="navbar-menu">
      <div class="navbar-start">
        <a class="navbar-item">
          Home
        </a>
  
        <a class="navbar-item">
          Docs
        </a>
  
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">
            More
          </a>
  
          <div class="navbar-dropdown">
            <a class="navbar-item">
              About
            </a>
            <a class="navbar-item">
              Contact
            </a>
            <hr class="navbar-divider">
            <a class="navbar-item">
              Report an issue
            </a>
          </div>
        </div>
      </div>
  
      <div class="navbar-end">
        <div class="navbar-item">
          <div class="buttons">
            <button class="button is-small is-disabled" onclick=""> NONAME </button>
            
            <button class="button is-primary is-large is-rounded is-success" onclick="r3Run();">Run</button>
             | 
            <button class="button is-info" onclick="document.getElementById('src').value=ex2;"> Ex 2 </button>
             | 
			<button class="button is-info" onclick="document.getElementById('src').value=ex3;"> Ex 3 </button>
			
			<!-- <button onclick="r3Load('fonti.r3');"> load </button> -->

            <button class="button is-primary is-large is-rounded" onclick="r3Compile();">Compile</button>    
            <button class="button is-primary is-large is-rounded is-success" onclick="r3step();dumpVM();redraw();">Step</button>
            <a class="button is-primary">
              <strong>Sign up</strong>
            </a>
            <a class="button is-light">
              Log in
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="columns">
    <div class="column">
      <div class="panel">
        <div class="field">
          <div class="control">
        <textarea id="src" cols="30" rows="25" class="textarea is-primary is-medium">| Example 1

:vframe 0 sysmem ;
:sw 1 sysmem ; 
:sh 2 sysmem ;

:patternxor
 vframe >a
 sh ( 1? 1 -
  sw ( 1? 1 -
    2dup xor 16 << a!+
    ) drop
  ) drop ;
 
 patternxor 
| 'patternxor onshow 
</textarea>

<script>

var ex2=`| Example 2
:vframe 0 sysmem ;
:sw 1 sysmem ; 
:sh 2 sysmem ;

#bit (
%........
%..1111..
%.11..11.
%.1....1.
%.111111.
%.1....1.
%.1....1.
%........ )

:drawline 
 8 ( 1?
  swap dup 
  1 and 23 << a!+
  1 >> swap 1 - ) 2drop ;
  
:drawbit | n --
 vframe >a
 8 ( 1? swap
   c@+ drawline
   sw 8 - 2 << a+
   swap 1 - ) 2drop ;

 'bit drawbit 
`;

var ex3=`| Example 3
:.s 0 syscall ;

:.d
 ;

:<br> 
 "<br" .s ;
 
:<btn> 
 "<button onclick='r3go(" .s swap .d ");'>" .s .s "</button>" .s ;
 
#var

:suma1 1 'var +! ;

:dom
	var .d <br>
	'suma1 "+1" <btn>
	;

 dom 
`;

</script>

          </div>
        </div>
      </div>
    </div>

    <div class="column">
      <canvas id="canvas" width="512" height="512" ></canvas>
      <div id="r3dom"></div>
    </div>
      
    <div class="column">
      <div class="panel">
      DATA STACK:<div id="ds"></div><br>
      CODE STACK:<div id="cs"></div><br>
      
      MEMDATA:<div id="md"></div><br>
      DICC:<div id="dic"></div><br>
      IP:<div id="ip"></div> ERR:<div id="logerror"></div><br>
      </div>
      <div class="panel">
      MEMCODE:<div id="mc"></div><br>
      </div>
    </div>
  </div>
	
  </body>
</html>