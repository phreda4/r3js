<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>r3</title>

<!-- // JUERA BICHO	-->
    <link rel="stylesheet" href="https://rawgit.com/jenil/bulmaswatch/gh-pages/cyborg/bulmaswatch.min.css" />
    <script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
<!-- // ----- ----- -->
	
    <script src="./compiler.js"></script>

<script>
// DEBUG
//----------------------------------------------------
function dumpmd() { var s="";
	for(var i=meminidata;i<memd;i++) { s=s+" "+mem.getInt8(i); }
	return s;
	}

function dumpmc() {	var s="";
	for(var i=0;i<memc;i++) {
		if (i==ip) { s+=" >>"; } 
		s+=printmr3(memcode[i])+" ";
		if (i==ip) { s+="<< "; }
//		s+="\n";
		}
	return s;
	}
function dumpdicc() { var s="";
	for (var i=0;i<dicc.length;i++) { s+=dicc[i]+" "+dicca[i]+" "+dicci[i]+"\n"; }
	return s;
	}

function dumpinc() { var s="";

	for(var i=0;i<sessionStorage.length;i++) { s+=sessionStorage.key(i)+"\n"; }
	  
//	for (var i=0;i<includes.length;i++) { s+=includes[i]+"\n"; }
	return s;
	}
	
const setDiv=(id,value)=>document.getElementById(id).innerText=value;

function dumpVM() {
	setDiv("ip", ip);
	setDiv("ds", [TOS, ...(stack.slice(2, NOS+1).reverse())].join(" "));
    setDiv("cs", stack.slice(RTOS,255).join(" "));
    setDiv("mc", dumpmc());
    setDiv("md", dumpmd());
	setDiv("dic",dumpdicc());
	setDiv("inc",dumpinc());	
    }

// VM
//----------------------------------------------------	
function r3Compile() { 
	r3reset();
	if (r3compile(document.getElementById("src").innerText)!=0) {
		}
	dumpVM(); 
	}
	
function r3Run() { 
	r3echo="";
	r3reset();
	if (r3token(document.getElementById("src").innerText)!=0) {// error
		dumpVM(); 
		return;
		}
	r3run();
	redraw();
	dumpVM(); 
	document.getElementById("r3dom").innerHTML=r3echo;
	}
	
//  Includes
//----------------------------------------------------
async function loadincludes() {
	if (window.sessionStorage == null) { alert("error de confianza");return; }
	let libsText = await(await fetch("./libs.txt")).text();
	for (let libname of libsText.split("\n")) {
		sessionStorage[libname] = await (await fetch(libname)).text();
	}
	dumpVM();
}

//  Examples
//----------------------------------------------------
function loadex(str) {
  document.getElementById('src').innerText=str;
  }

//----------------------------------------------------
// PLAY IN TAB
//----------------------------------------------------  
function playintab() {
	var wcanvas=512;
	var hcanvas=512;
    var pag=window.open();
    var srccode = document.getElementById("src").innerText;
    var pagsource = `<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>r3</title>
    <script src="./compiler.js"><\/script>
    <script type="text/r3">${srccode}<\/script>
  <\/head>
  <body>
    <div id="r3dom"></div>
    <canvas id="canvas" width="${wcanvas}" height="${hcanvas}" ></canvas>
    <script>r3scanrun();<\/script>
  <\/body>
<\/html>`;
    pag.document.write(pagsource);
  }
  
//----------------------------------------------------
// Examples in r3
//----------------------------------------------------

var ex1=`| Example 1

^lib/gr.r3

:patternxor
 vframe >a
 sh ( 1? 1 -
  sw ( 1? 1 -
    2dup xor 16 << 
	$ff or | opacity
	a!+
    ) drop
  ) drop ;
 
 patternxor 
| 'patternxor onshow 
`;
//----------------------------------------------------
var ex2=`| Example 2

^lib/gr.r3
^lib/fonti.r3

:print | str --
  0 0 xy>v >a   
  ( c@+ 1? 
    char8i ) 
  2drop ;
  
"Hola" print
`;
//----------------------------------------------------
var ex3=`| Example 3

^lib/dom.r3

#var 0

:1+ 1 'var +! ;
:1- -1 'var +! ;

:dom
  <br>
  "Hola Mundo" .s <br>
  '1- " -1 " <btn>
  " " .s var .d " " .s
  '1+ " +1 " <btn>
  ;

'dom ondom
dom 
`;
//----------------------------------------------------
var ex4=`| Example 4

^lib/gr.r3
  
|--------------------
#x 10 #vx 1
#y 10 #vy 1

:hitx vx neg 'vx ! ;
:hity vy neg 'vy ! ;

:box
 xy>v >a $ff00ff a! ;
	
:show
 cls
 
 x sw 4 - >=? ( hitx ) 4 <=? ( hitx ) 
 y sh 4 - >=? ( hity ) 4 <=? ( hity ) 
 box
 vx 'x +!
 vy 'y +!
 ;

|--------------------	
'show onshow
`;

var ex5=`| Example 5 DRAW in Canvas

##ink $ff00ff

:keycode 6 sysmem ;
:keychar 7 sysmem ;
:xymouse 8 sysmem ;

::vframe 0 sysmem ;
::sw 1 sysmem ; 
::sh 2 sysmem ;

::onshow 2 syscall ;

::xy>v | x y -- adr
  sw * + 2 << vframe + ;

::cls
  0 vframe sw sh * fill ;

:hit
  keycode -1 <>? ( ink $ff00 xor 'ink ! ) 
  drop ;
  
::ondom 1 syscall ;
::echo 0 syscall ;
 

#mbuff * 48 

:sign | sign --
 -? ( drop $2d over c! ; ) drop 1 + ;
 
::.d | val -- str
 dup abs
 'mbuff 47 + 0 over c! 1 -  
 swap ( 10 /mod $30 + pick2 c! swap 1 - swap 1? ) drop
 swap sign ;
 
:dom
 "tecla :" echo
  keycode .d echo
  " " echo
  keychar .d echo
  
  ;
  
:show
  xymouse dup $ffff and swap 16 >> 
  xy>v >a 
  |ink 
  3 sysmem 18 << $ff or 
  dup a!+ a!+ 
  hit
  ;

'dom ondom  
'show onshow

`;

// DEV-WEB
//----------------------------------------------------
</script>
</head>
<body>
  <nav class="navbar" role="navigation">
	<a class="navbar-item" href="https://github.com/r3www/r3">r3</a>

    <div id="navbarMenu" class="navbar-menu">

      <div class="navbar-start">
        <div class="navbar-item">
			<div class="buttons">
            
            <button class="button is-success" onclick="r3Run();">Play</button>
			<button class="button is-success" onclick="playintab();">Play in Tab</button>
			
            <button class="button is-primary" onclick="r3Compile();">Compile</button>
            <button class="button" onclick="r3step();dumpVM();redraw();">Step</button>

			<button class="button">Includes</button>
			
          <div class="dropdown is-hoverable">
            <div class="dropdown-trigger">
              <button 
                class="button"
                aria-haspopup="true"
                aria-controls="dropdown-menu">
                <span>Examples</span>
                <span class="icon is-small">
                  <i class="fas fa-angle-down"></i>
                </span>
              </button>
            </div>
   
            <div
              class="dropdown-menu"
              id="dropdown-menu"
              role="menu">
              <div class="dropdown-content">
                <a href="#" class="dropdown-item" onclick="loadex(ex1);">Pattern XOR in canvas</a>
                <a href="#" class="dropdown-item" onclick="loadex(ex2);">Font test</a>
                <a href="#" class="dropdown-item" onclick="loadex(ex3);">DOM test</a>
                <a href="#" class="dropdown-item" onclick="loadex(ex4);">SHOW test</a>
				<a href="#" class="dropdown-item" onclick="loadex(ex5);">XYMOUSE test</a>
				
              </div>
            </div>
          </div>			
			
			</div>
        </div>
      </div>
	  
      <div class="navbar-end">
	  
        <a class="navbar-item">No Docs</a>
        <a class="navbar-item">No Settings</a>
		
      </div>
	  
    </div>
  </nav>

  <div class="columns">
    <div class="column is-narrow">
		<div class="panel">
			<div class="panel-block">
				<div id="src" contenteditable="true" style="font-family:Monospace;color:#fff;background-color:#444;">| r3 code</div>
			</div>
		</div>	  
    </div>

	<div class="column">
		<div id="r3dom"></div>
		<div id="r3canvas" >
		<canvas id="canvas" width="512" height="512" ></canvas> 
		</div>
	</div>

    <div class="column">
      <div class="panel" style="font-family:Monospace;">
	  
DS:<div id="ds"></div>
RS:<div id="cs"></div>
IP:<div id="ip"></div>
ERR:<div id="logerror"></div>
INC:<div id="inc"></div><br>	  
DIC:<div id="dic"></div><br>
MEMCODE:<div id="mc" ></div><br>
MEMDATA:<div id="md"></div><br>

      </div>
    </div>
  </div>
  
<script>
/////////
// BOOT//
/////////
sessionStorage.clear();
loadincludes().then(canvasini);
</script>

  </body>
</html>
