<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>r3</title>
	
	<link rel="stylesheet" href="use/bulma.min.css" />
	<link rel="stylesheet" href="use/ico.css" />	
	
	<link rel="stylesheet" href="use/codemirror.css" />
<!--	<link rel="stylesheet" href="use/colorforth.css">  -->
	<script src="use/codemirror.js"></script>

	<script src="use/jszip.min.js"></script>

    <script src="compiler.js"></script>

</head>
<body class="has-navbar-fixed-top">
  <nav class="navbar is-fixed-top" role="navigation">
  <a class="navbar-item">r3&nbsp;
	<button id="mainbtn" class="button is-success is-outlined" onclick="r3RunState();">
	  <i id="mainico" class="ico icon-play"></i>
	</button>
	<button id="debugbtn" class="button is-primary is-outlined" onclick="r3Compile();">
	  <i class="ico icon-cog"></i>
	</button>
  </a>

  <div id="navbarMenu" class="navbar-menu">
    <div class="navbar-start">
      <div class="navbar-item">
      <div class="buttons">
<!--	  
	<button class="button is-success" onclick="playintab();"><i class="ico icon-play"></i></button>
	<button class="button is-primary" onclick="r3step();dumpVM();redraw();"><i class="ico icon-right-open"></i></button>
-->

		<div id="filesis"></div>
		
      </div>
    </div>
  </div>

      <div class="navbar-end">
	  
<!--        <a class="navbar-item">No Docs</a>
        <a class="navbar-item">No Settings</a>
		-->
      </div>

    </div>
  </nav>

  <div id="modedit" >
  <div class="columns">
    <div class="column is-half">
	
  <nav class="tabs is-boxed" style="margin:0">
        <div class="container" id="codetabs">
		
<!--		
          <ul>
            <li class="tab is-active" onclick="openTab(event,'WebDev')"><a>new</a></li>
            <li class="tab" onclick="openTab(event,'WebAud')"><a>lib</a></li>
            <li class="tab" onclick="openTab(event,'Support')"><a>coso</a></li>
          </ul>
-->		  
        </div>
  </nav>
	  
    <div id="src"></div> 
    </div>

    <div class="column">
      <div class="panel" style="font-family:Monospace;">
	  
  
		<div> IP:<span id="ip" class="tag is-warning"></span> <span id="logerror"></span></div>
		<div>D:<span id="ds"></span><br></div>
		<div>R:<span id="cs"></span><br></div>

MEMCODE:<div id="mc" ></div><br>
MEMDATA:<div id="md"></div><br>
<div id="dic"></div><br>

      </div>
    </div>
	
	</div>
  </div>
  
  <div id="moderun" style="display:none;">
    <div id="r3dom"></div>
    <div id="r3canvas">
    <canvas id="canvas" width="512" height="512" ></canvas>

    </div>
  </div>

  <div id="modeload" style="display:none;">
    <input type="file" id="file" name="file"/>
  </div>
  
<script>
// DEBUG
//----------------------------------------------------
function dumpmd() { var s="";
  for(var i=meminidata;i<memd;i++) { s=s+" "+mem.getInt8(i); }
  return s;
  }

function dumpmc() { var s="";
  for(var i=0;i<memc;i++) {
    if (i==ip) { s+=" >>"; }
    s+=printmr3(memcode[i])+" ";
    if (i==ip) { s+="<< "; }
//    s+="\n";
    }
  return s;
  }
  
function dumpinc() { var s="";
//  for(var i=0;i<sessionStorage.length;i++) { s+=sessionStorage.key(i)+"\n"+sessionStorage.getItem(sessionStorage.key(i))+"\n"; }
  for (var i=0;i<includes.length;i++) { s+=includes[i]+"\n"; }
  return s;
  }
  
function dumpd() { var s="";
  if (NOS==0) {return s;}
  s+='<span class="tag is-success">'+TOS+'</span>';
  for (var i=NOS;i>1;i--) { s+='<span class="tag is-success">'+stack[i]+'</span>';}
  return s;
  }

function dumpr() { var s="";
  for (var i=RTOS;i<254;i++) { s+='<span class="tag is-link">'+stack[i]+'</span>';}
  return s;
  }
  
function dumpdicc() { var s="";
	s+="<table class='table is-bordered is-striped is-narrow is-hoverable is-fullwidth'>";
  for (var i=0;i<dicc.length;i++) { 
	s+="<tr>";  
	s+="<td>"+dicc[i]+"</td><td>"+dicca[i]+":"+dicci[i]+"</td><td>"+dicci[i]+"</td>"; 
	s+="</tr>";  	
	}
	s+="</table>";	
  return s;
  }
  
const setDiv=(id,value)=>document.getElementById(id).innerText=value;
const setDivH=(id,value)=>document.getElementById(id).innerHTML=value;

function dumpVM() {
  setDiv("ip", ip);
  setDivH("ds", dumpd());
  setDivH("cs", dumpr());
  setDivH("dic",dumpdicc());
  setDiv("mc", dumpmc());
  setDiv("md", dumpmd());
  }

// VM
//----------------------------------------------------
function r3Compile() {
  var src=editor.getValue("\n");
  var cc=r3compile(src);
  if (cc>-1) {
	var i,ll=0;lin=0;
	for(i=0;i<cc;i++){ if(src[i]=="\n") {lin++;ll=i+1;} }
	var c=cc-ll;
	editor.focus();
	editor.setCursor({line:lin,ch:c});
    }
  dumpVM();
  }

function dumpError(){
}

function r3Run() {
  if (r3compile(editor.getValue("\n"))>-1) {// error
	dumpError();
    dumpVM();
    return;
    }
	
  r3reset();
  r3run();
  
  redraw();
  document.getElementById("r3dom").innerHTML=r3echo;
  dumpVM();  
  }

function r3Stop() {
eventDel();
document.getElementById('moderun').style.display = 'none';
document.getElementById('modedit').style.display = 'block';
document.getElementById('mainbtn').onclick = r3RunState;
document.getElementById('mainbtn').classList.remove('is-danger');
document.getElementById('mainbtn').classList.add('is-success');
document.getElementById('mainico').className = "ico icon-play";
editor.focus();
}

function r3RunState() {
  if (r3compile(editor.getValue("\n"))>-1) {// error
	dumpError();
    dumpVM();
    return;
    }

document.getElementById('modedit').style.display = 'none';
document.getElementById('moderun').style.display = 'block';
document.getElementById('mainbtn').onclick = r3Stop;
document.getElementById('mainbtn').classList.remove('is-success');
document.getElementById('mainbtn').classList.add('is-danger');
document.getElementById('mainico').className = "ico icon-stop";

  canvasini();    
  
  r3reset();
  r3run();
  
  redraw();
  document.getElementById("r3dom").innerHTML=r3echo;
  dumpVM();  
  }
  
//  Examples
//----------------------------------------------------
function codeload(name) {
  sessionStorage.setItem(nametab,editor.getValue("\n"));
  editor.setValue(sessionStorage.getItem(name));
  nametab=name;
  addtab(name);
}

//----------------------------------------------------
// PLAY IN TAB
//----------------------------------------------------
function playintab() {
  var wcanvas=512;
  var hcanvas=512;
  var pag=window.open();

  var srccode=editor.getValue("\n");
  
  r3includes(srccode);

  var presource="";
  for (var i=0;i<includes.length;i++) {
    presource+=sessionStorage.getItem(includes[i]);
    }

  var pagsource = `<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>r3</title>
    <script src="./compiler.js"><\/script>
    <script type="text/r3">${presource}
	${srccode}<\/script>
  <\/head>
  <body bgcolor="#000"><center>
    <div id="r3dom"></div>
    <canvas id="canvas" width="${wcanvas}" height="${hcanvas}" ></canvas>
	</center>
    <script>r3scanrun();<\/script>
  <\/body>
<\/html>`;

  pag.document.write(pagsource);
  }

/////////
// BOOT//
/////////
sessionStorage.clear();

var editor = CodeMirror(document.getElementById("src"), {
  //mode: "text/html",
  lineNumbers: true,
  styleActiveLine: true,
  autofocus:true,
  gutters: ["note-gutter", "CodeMirror-linenumbers"],
  //	theme:"colorforth"
  });
editor.setSize("100%","100%");

//editor.setGutterMarker(0, "note-gutter", document.createTextNode("hi"));

</script>

  </body>
</html>

<!--
<h3>load session storage</h3>
<input type="file" id="file" name="file"/><br />
<button onclick="versess();">Ver</button>
<div id="result_block">
  <h3>file :</h3>
  <div id="result"></div>
</div>
-->
<script>

//-------------------------
var nametab="";
var codetabs=[];

function gentab(name) {
var d=document.getElementById("codetabs");
var s="<ul>";
for(var i=0;i<codetabs.length;i++) {
  s+="<li class='tab";
  if (codetabs[i]==name) { s+=" is-active"; }  
  s+="' onclick='openTab(event,"+'"'+codetabs[i]+'"'+")'><a>"+codetabs[i];
  s+="&nbsp;<button class='delete is-small' onclick='deltab("+'"'+codetabs[i]+'"'+");'></button></a></li>";
  }
s+="</ul>";
d.innerHTML=s;
}

function newempty() {
nametab='new';
addtab(nametab);
sessionStorage.setItem(nametab,"");
editor.setValue(sessionStorage.getItem(nametab));
}

function addtab(name) {
var index=codetabs.indexOf(name);
if (index==-1) {
  codetabs.push(name);
  gentab(name);
  }
}

function deltab(name) {
var index=codetabs.indexOf(name);
if (index>-1) {
  codetabs.splice(index,1);
  if (codetabs.length==0) { newempty();return; } 
  if (index>0) index--;
  gentab(codetabs[index]);
  editor.setValue(sessionStorage.getItem(codetabs[index]));
  }
return false;
}

function openTab(evt, tabName) {
  var i, tablinks;
  tablinks = document.getElementsByClassName("tab");
  for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" is-active", "");
  }
  evt.currentTarget.className += " is-active";
  
  sessionStorage.setItem(nametab,editor.getValue("\n"));
  editor.setValue(sessionStorage.getItem(tabName));
  nametab=tabName;
}

//------------------------------------------
function addfilep(path,name) {
var d=document.getElementById("mp"+path);
if (d==null) {
var s=`
<div class="dropdown is-hoverable">
 <div class="dropdown-trigger">
  <button class="button" aria-haspopup="true" aria-controls="dropdown-menu">
   <span>${path}<\/span>
   <span class="icon is-small"><i class="ico icon-down-dir"><\/i><\/span>
  <\/button>
 <\/div>
 <div class="dropdown-menu" id="dropdown-menu" role="menu">
  <div class="dropdown-content" id="mp${path}"><\/div>
 <\/div>
<\/div>`;
var i=document.getElementById("filesis");
i.innerHTML+=s;
d=document.getElementById("mp"+path);
}
d.innerHTML+='<a href="#" class="dropdown-item" onclick="codeload('+"'"+path+"/"+name+"'"+');">'+name+'</a>';
}

function addfile(name,s) {
if (s=="") return;
sessionStorage.setItem(name,s);
var path=name.split("/");
if (path[1]!=null) {
  addfilep(path[0],path[1]);
  }
  
}

//---------------------- from url
function fromURL(name) {
sessionStorage.clear();
fetch(name)
.then(function (response) { if (response.status === 200 || response.status===0) { 
  return Promise.resolve(response.blob());
} else {
  return Promise.reject(new Error(response.statusText));
  }
})
.then(JSZip.loadAsync)
.then( function (zip) {
  zip.forEach(function (name,file){
    file.async("string").then(function (s) { addfile(name,s); });
    });
});
}

//---------------------- from file
document.getElementById("file").addEventListener("change", function(evt) {
    // Closure to capture the file information.
    function handleFile(f) {
        JSZip.loadAsync(f)                                   // 1) read the Blob
        .then( function(zip) {
            zip.forEach(function (name, file) {  // 2) print entries
				file.async("string").then(function (s) { addfile(name,s); });
                });
        }, function (e) {  });
    }

	sessionStorage.clear();
    var files = evt.target.files;
    for (var i = 0; i < files.length; i++) {
        handleFile(files[i]);
	
    }
},false);

//---------------------- DUMP
function versess() {
var $result =document.getElementById("result");
$result.innerHTML='';
for(var i=0;i<sessionStorage.length;i++){
	var name=sessionStorage.key(i);
	//var precio=sessionStorage.getItem(producto);
	var cont="..";
	$result.innerHTML += '<div>'+name+' - '+cont+'</div>';
	}
}

//--- BOOT
fromURL('r3.zip');
newempty();
</script>