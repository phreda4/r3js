<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>r3</title>
	
	<link rel="stylesheet" href="./use/bulma.min.css" />
	<link rel="stylesheet" href="./use/ico.css" />	

	<link rel="stylesheet" href="./use/codemirror.css" />
<!--	<link rel="stylesheet" href="./use/colorforth.css">  -->
	<script src="use/codemirror.js"></script>

    <script src="./compiler.js"></script>

</head>
<body>
  <nav class="navbar" role="navigation">
  <a class="navbar-item" href="https://github.com/r3www/r3">r3</a>

    <div id="navbarMenu" class="navbar-menu">

      <div class="navbar-start">
        <div class="navbar-item">
      <div class="buttons">

	<button class="button is-success" onclick="r3Run();"><i class="ico icon-play"></i></button>
	
	<button class="button is-success" onclick="playintab();"><i class="ico icon-play"></i><i class="ico icon-window-maximize"></i></button>

	<button class="button is-primary" onclick="r3Compile();"><i class="ico icon-cog"></i></button>
	<button class="button is-primary" onclick="r3step();dumpVM();redraw();"><i class="ico icon-right-open"></i></button>

<!-- <button class="button">Includes</button> -->
	  
          <div class="dropdown is-hoverable">
            <div class="dropdown-trigger">
              <button
                class="button"
                aria-haspopup="true"
                aria-controls="dropdown-menu">
                <span>Examples</span>
                <span class="icon is-small">
					<i class="ico icon-down-dir"></i>				  
                </span>
              </button>
            </div>

            <div
              class="dropdown-menu"
              id="dropdown-menu"
              role="menu">
              <div class="dropdown-content">
                <a href="#" class="dropdown-item" onclick="loadex('r3/examples/Pattern-XOR-in-canvas.r3');">Pattern XOR in canvas</a>
                <a href="#" class="dropdown-item" onclick="loadex('r3/examples/Font-test.r3');">Font test</a>
                <a href="#" class="dropdown-item" onclick="loadex('r3/examples/DOM-test.r3');">DOM test</a>
                <a href="#" class="dropdown-item" onclick="loadex('r3/examples/SHOW-test.r3');">SHOW test</a>
                <a href="#" class="dropdown-item" onclick="loadex('r3/examples/XYMOUSE-test.r3');">XYMOUSE test</a>
              </div>
            </div>
          </div>

      </div>
        </div>
      </div>

      <div class="navbar-end">
        <a class="navbar-item">No Docs</a>
        <a class="navbar-item">No Settings</a>
      </div>

    </div>
  </nav>

  <div class="columns">
    <div class="column is-quarter">
        <div id="src"></div>
		<div> IP:<span id="ip" class="tag is-warning"></span> <span id="logerror"></span></div>
		<div>D:<span id="ds"></span><br></div>
		<div>R:<span id="cs"></span><br></div>
		
    </div>

  <div class="column">
    <div id="r3dom"></div>
    <div id="r3canvas" >
    <canvas id="canvas" width="512" height="512" ></canvas>
    </div>
  </div>

    <div class="column">
      <div class="panel" style="font-family:Monospace;">




MEMCODE:<div id="mc" ></div><br>
MEMDATA:<div id="md"></div><br>
<div id="dic"></div><br>
      </div>
    </div>
  </div>

<script>
// DEBUG
//----------------------------------------------------
function dumpmd() { var s="";
  for(var i=meminidata;i<memd;i++) { s=s+" "+mem.getInt8(i); }
  return s;
  }

function dumpmc() { var s="";
  for(var i=0;i<memc;i++) {
    if (i==ip) { s+=" >>"; }
    s+=printmr3(memcode[i])+" ";
    if (i==ip) { s+="<< "; }
//    s+="\n";
    }
  return s;
  }
  
function dumpinc() { var s="";
//  for(var i=0;i<sessionStorage.length;i++) { s+=sessionStorage.key(i)+"\n"+sessionStorage.getItem(sessionStorage.key(i))+"\n"; }
  for (var i=0;i<includes.length;i++) { s+=includes[i]+"\n"; }
  return s;
  }
  
function dumpd() { var s="";
  if (NOS==0) {return s;}
  s+='<span class="tag is-success">'+TOS+'</span>';
  for (var i=NOS;i>1;i--) { s+='<span class="tag is-success">'+stack[i]+'</span>';}
  return s;
  }

function dumpr() { var s="";
  for (var i=RTOS;i<254;i++) { s+='<span class="tag is-link">'+stack[i]+'</span>';}
  return s;
  }
  
function dumpdicc() { var s="";
	s+="<table class='table is-bordered is-striped is-narrow is-hoverable is-fullwidth'>";
  for (var i=0;i<dicc.length;i++) { 
	s+="<tr>";  
	s+="<td>"+dicc[i]+"</td><td>"+dicca[i]+":"+dicci[i]+"</td><td>"+dicci[i]+"</td>"; 
	s+="</tr>";  	
	}
	s+="</table>";	
  return s;
  }
  
const setDiv=(id,value)=>document.getElementById(id).innerText=value;
const setDivH=(id,value)=>document.getElementById(id).innerHTML=value;

function dumpVM() {
  setDiv("ip", ip);
  setDivH("ds", dumpd());
  setDivH("cs", dumpr());
  setDivH("dic",dumpdicc());
  setDiv("mc", dumpmc());
  setDiv("md", dumpmd());
  }

// VM
//----------------------------------------------------
function r3Compile() {
  var src=editor.getValue("\n");
  var cc=r3compile(src);
  if (cc>-1) {
	var i,ll=0;lin=0;
	for(i=0;i<cc;i++){ if(src[i]=="\n") {lin++;ll=i+1;} }
	var c=cc-ll;
	editor.focus();
	editor.setCursor({line:lin,ch:c});
    }
  dumpVM();
  }

function r3Run() {
  if (r3compile(editor.getValue("\n"))>-1) {// error
    dumpVM();
    return;
    }
  r3reset();
  r3run();
  redraw();
  dumpVM();
  document.getElementById("r3dom").innerHTML=r3echo;
  }

//  Includes
//----------------------------------------------------

async function loadincludes() {
  if (window.sessionStorage == null) { alert("error de confianza");return; }
  let libsText = await(await fetch("./r3/libs.txt")).text();
  for (let libname of libsText.trim().split("\n")) {
    libname="r3/"+libname.trim();
    sessionStorage.setItem(libname,await (await fetch(libname)).text());
  }
dumpVM();  
}

//  Examples
//----------------------------------------------------
async function loadex(str) {
  const source = await(await fetch(str)).text();
  editor.setValue(source);
}

//----------------------------------------------------
// PLAY IN TAB
//----------------------------------------------------
function playintab() {
  var wcanvas=512;
  var hcanvas=512;
  var pag=window.open();

  var srccode=editor.getValue("\n");
  
  r3includes(srccode);

  var presource="";
  for (var i=0;i<includes.length;i++) {
    presource+=sessionStorage.getItem(includes[i]);
    }

  var pagsource = `<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>r3</title>
    <script src="./compiler.js"><\/script>
    <script type="text/r3">${presource}
	${srccode}<\/script>
  <\/head>
  <body bgcolor="#000"><center>
    <div id="r3dom"></div>
    <canvas id="canvas" width="${wcanvas}" height="${hcanvas}" ></canvas>
	</center>
    <script>r3scanrun();<\/script>
  <\/body>
<\/html>`;

  pag.document.write(pagsource);
  }

/////////
// BOOT//
/////////
sessionStorage.clear();

var editor = CodeMirror(document.getElementById("src"), {
  mode: "text/html",
  lineNumbers: true,
  styleActiveLine: true,
  autofocus:true,
  //	theme:"colorforth"
  });
editor.setSize("100%","100%");
	  
loadincludes();

canvasini();
</script>

  </body>
</html>
